## Итоги аудита (критичные выводы)

### Несоответствие архитектуры документации
- [ARCHITECTURE.md](file:///c:/Users/User/Desktop/corp/ARCHITECTURE.md) описывает Marzban/Xray/VLESS, а фактическая реализация — Blitz/Hysteria2 + Mongo + Automation Service (FastAPI/Aiogram). Это вводит в заблуждение и мешает эксплуатации.

### Риски безопасности (P0)
- В [.env](file:///c:/Users/User/Desktop/corp/.env) присутствуют реальные секреты (Telegram token, пароли). Файл игнорируется через [.gitignore](file:///c:/Users/User/Desktop/corp/.gitignore), но хранение реальных секретов в рабочей папке и тем более возможный коммит — критический риск.
- В [docker-compose.yml](file:///c:/Users/User/Desktop/corp/docker-compose.yml) стоят небезопасные дефолты `${...:-qwerty123}` и `${...:-token123}` для Blitz. В режиме «из коробки» это приводит к развертыванию с известными паролями.
- В [.gitignore](file:///c:/Users/User/Desktop/corp/.gitignore) папка `configs/` игнорируется, но часть нужных файлов (например `configs/hysteria2_client_template.env`) сейчас будет игнорироваться из-за шаблонов исключений. Это ломает воспроизводимость.

### Функциональные ошибки (P0)
- Несогласованность полей `marzban_username` vs `blitz_username` между [main.py](file:///c:/Users/User/Desktop/corp/automation-service/main.py) и схемой БД в [database.py](file:///c:/Users/User/Desktop/corp/automation-service/database.py) (таблица `users`). Это приведет к ошибкам в рантайме.
- Сигнатура `Database.add_user(...)` требует `hy2_auth_key`, но вызов в [main.py](file:///c:/Users/User/Desktop/corp/automation-service/main.py) не передает этот аргумент — риск падения при выдаче доступа.
- [webhooks.py](file:///c:/Users/User/Desktop/corp/automation-service/webhooks.py) использует `MarzbanClient` (хотя подразумевается Blitz) и также завязан на `marzban_username`.
- В [database.py](file:///c:/Users/User/Desktop/corp/automation-service/database.py) используется `timedelta` без импорта (в `lock_user`) — потенциальный runtime error.

### Отказоустойчивость и восстановление (P1)
- На VPS встречалась ошибка Docker snapshot/export (уровень Docker/BuildKit). Это не лечится кодом приложения, но нужно добавить «мягкий» сценарий восстановления в документацию и скрипты.
- Healthchecks в compose есть, но процедуры восстановления должны быть стандартизованы (не `docker system prune` без предупреждений).

### Эффективность и масштабируемость (P2)
- `automation-service` совмещает API + Telegram polling в одном процессе. При росте нагрузки лучше разделить на два сервиса (API и bot-worker) или вынести polling в отдельный контейнер.
- В проде стоит запускать API через gunicorn/uvicorn workers и настроить лимиты ресурсов (compose).

## План исправлений (что будет сделано)

### 1) Безопасность и секреты
- Удалить реальный [.env](file:///c:/Users/User/Desktop/corp/.env) из репозитория/истории (если попал в git), добавить заметный баннер в README.
- Убрать небезопасные дефолты из [docker-compose.yml](file:///c:/Users/User/Desktop/corp/docker-compose.yml): сделать `BLITZ_ADMIN_PASSWORD` и `BLITZ_SECRET_KEY` строго обязательными.
- Привести [.env.example](file:///c:/Users/User/Desktop/corp/.env.example) к полному списку переменных и комментариев.
- Исправить правила [.gitignore](file:///c:/Users/User/Desktop/corp/.gitignore) для `configs/`, чтобы шаблоны, необходимые «из коробки», не игнорировались.

### 2) Починка логики Automation Service
- Нормализовать модель пользователя: везде использовать `blitz_username` (и миграцию/совместимость с уже существующими БД).
- Исправить `add_user`/выдачу ключей: гарантировать сохранение `hy2_auth_key`, `hy2_url`, `subscription_url`.
- Переписать [webhooks.py](file:///c:/Users/User/Desktop/corp/automation-service/webhooks.py) на работу с Blitz API (убрать `MarzbanClient` и устаревшие эндпоинты).
- Добавить минимальные автотесты на БД-слой и генерацию/валидацию ID.

### 3) Деплой «одной командой» и воспроизводимость
- Унифицировать документацию запуска в [README.md](file:///c:/Users/User/Desktop/corp/README.md), [DEPLOYMENT.md](file:///c:/Users/User/Desktop/corp/DEPLOYMENT.md), [ADMIN_GUIDE.md](file:///c:/Users/User/Desktop/corp/ADMIN_GUIDE.md) без требований `scp` как обязательного условия (добавить вариант `git clone`/`git pull`).
- Привести [deploy_vps.sh](file:///c:/Users/User/Desktop/corp/deploy_vps.sh) к реальности: не требовать `blitz_source` руками, если Dockerfile умеет подтягивать исходники.
- Добавить явный healthcheck/depends_on цепочки и проверку готовности на первом старте.

### 4) Архитектура и документация
- Обновить [ARCHITECTURE.md](file:///c:/Users/User/Desktop/corp/ARCHITECTURE.md), чтобы отражал Blitz/Hysteria2.
- Убрать/перенести нерелевантные документы (например [GEMINI.MD](file:///c:/Users/User/Desktop/corp/GEMINI.MD), [INSTALL.MD](file:///c:/Users/User/Desktop/corp/INSTALL.MD)) в отдельную папку tooling либо отметить как не относящиеся к VPN-стеку.
- Зафиксировать регламент корпоративных ID и админ-команды бота с примерами в [ID_POLICY.md](file:///c:/Users/User/Desktop/corp/ID_POLICY.md).

## Проверка результата
- Локально: `docker-compose up -d --build` без ручных правок файлов.
- Проверка health:
  - Blitz web: `http://localhost:8000/`
  - Automation: `http://localhost:8080/health`
- Smoke-тест выдачи доступа через API `/access/grant` и проверка ID-команд в Telegram.

Если подтверждаете — приступаю к исправлениям по плану и добавлю минимальный набор тестов/смоук-проверок для гарантии «из коробки». 